version: 2.1

jobs:
  test:
    docker:
      - image: cimg/php:8.2-node
        environment:
          APP_ENV: test
          DB_CONNECTION: mysql_test
          DB_HOST: mysql
          DB_DATABASE: demo_test
          DB_USERNAME: 'root'
          DB_PASSWORD: 'root'
      - image: mysql:8.0
        environment:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: demo_test

    steps:
      - checkout
      - run:
          name: Install Dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y libzip-dev unzip
            sudo docker-php-ext-install zip pdo_mysql
            
      - run:
          name: Install Composer Dependencies
          working_directory: ~/project/src
          command: composer install --no-interaction --prefer-dist --optimize-autoloader
          
      - run:
          name: Run Tests
          command: php artisan test --env=testing 

workflows:
  version: 2
  test:
    jobs:
      - test